<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Dashboard</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f4f6f8;color:#111}
    header{background:#0b5ed7;color:white;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
    header h1{margin:0;font-size:18px}
    main{padding:18px;max-width:1100px;margin:18px auto}
    .card{background:white;border-radius:10px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin:12px 0}
    input,select,textarea{font-size:14px;padding:8px;border-radius:6px;border:1px solid #d0d7de;width:100%;box-sizing:border-box}
    button{font-size:14px;padding:8px 12px;border-radius:6px;border:none;background:#0b5ed7;color:white;cursor:pointer;margin-top:8px}
    button:hover{background:#0a58ca}
    button.logout{background:#dc3545}
    button.logout:hover{background:#c82333}
    .row{display:flex;gap:10px}
    .row > div{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .muted{color:#6b7280;font-size:13px}
    label{display:block;margin-top:8px;font-weight:500}
  </style>
</head>
<body>
  <header>
    <h1>MEDF-PS20 â€” Patient Dashboard</h1>
    <div>
      <strong id="userName"></strong>&nbsp;&nbsp;
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h3>Book Appointment</h3>
      <div class="row">
        <div>
          <label>Choose Doctor</label>
          <select id="selectDoctor"></select>
          <label>Date & Time</label>
          <input id="apptDate" type="datetime-local" />
          <label>Reason for Appointment</label>
          <textarea id="apptReason" rows="3" placeholder="Describe your symptoms or concerns"></textarea>
          <button onclick="bookAppointment()">Proceed to Payment & Book</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>My Appointments</h3>
      <div id="patientAppts"></div>
    </section>
  </main>

  <script src="shared.js"></script>
  <script>
    // Require authentication
    const user = requireAuth()
    document.getElementById('userName').innerText = user.name

    function populateDoctors(){
      const sel = document.getElementById('selectDoctor')
      sel.innerHTML=''
      const doctors = load(DB_USERS_KEY).filter(u=>u.role==='doctor')
      if(doctors.length===0){
        const opt=document.createElement('option')
        opt.textContent='No doctors available'
        opt.disabled=true
        sel.appendChild(opt)
        return
      }
      doctors.forEach(d=>{
        const opt=document.createElement('option')
        opt.value=d.id
        opt.textContent=d.name+' ('+d.email+')'
        sel.appendChild(opt)
      })
    }

    function bookAppointment(){
      const doctorId = document.getElementById('selectDoctor').value
      const datetime = document.getElementById('apptDate').value
      const reason = document.getElementById('apptReason').value
      if(!doctorId||!datetime||!reason) return alert('Please fill all fields')
      if(!confirm('Simulate payment of â‚¹500 and complete booking?')) return
      const appts = load(DB_APPTS_KEY)
      const appt = {
        id:uid(),
        patientId:user.id,
        doctorId,
        datetime,
        reason,
        status:'pending',
        paid:true,
        videoLink:null,
        prescriptionId:null,
        createdAt:Date.now()
      }
      appts.push(appt)
      save(DB_APPTS_KEY, appts)
      alert('Appointment booked successfully! Doctor will review and approve.')
      // Clear form
      document.getElementById('selectDoctor').value=''
      document.getElementById('apptDate').value=''
      document.getElementById('apptReason').value=''
      renderPatientAppts()
    }

    function renderPatientAppts(){
      const appts = load(DB_APPTS_KEY).filter(a=>a.patientId===user.id)
      const container = document.getElementById('patientAppts')
      container.innerHTML=''
      if(appts.length===0){
        container.innerHTML='<p class="muted">No appointments yet</p>'
        return
      }
      const table=document.createElement('table')
      table.innerHTML='<tr><th>Doctor</th><th>Date & Time</th><th>Status</th><th>Actions</th></tr>'
      appts.forEach(a=>{
        const doc = load(DB_USERS_KEY).find(u=>u.id===a.doctorId)
        const tr=document.createElement('tr')
        let actions = ''
        if(a.videoLink) actions += '<a href="'+a.videoLink+'" target="_blank" style="color:#0b5ed7;text-decoration:none">ðŸ“¹ Join Call</a> '
        if(a.prescriptionId) actions += '<button onclick="viewPrescription(\''+a.prescriptionId+'\')">ðŸ“‹ View Rx</button>'
        tr.innerHTML = `<td>${doc?doc.name:'(deleted)'}</td><td>${new Date(a.datetime).toLocaleString()}</td><td><strong>${a.status}</strong></td><td>${actions||'â€”'}</td>`
        table.appendChild(tr)
      })
      container.appendChild(table)
    }

    function viewPrescription(id){
      const p = load(DB_PRESC_KEY).find(x=>x.id===id)
      if(!p) return alert('Prescription not found')
      alert('Prescription:\n\n'+p.text)
    }

    // Initialize
    populateDoctors()
    renderPatientAppts()
  </script>
</body>
</html>
